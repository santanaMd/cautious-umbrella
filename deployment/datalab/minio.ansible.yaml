#
##
### MiniIO
##
#

- name: Instalar o chart MinIO usando Helm
  community.kubernetes.helm:
    chart_ref: oci://registry-1.docker.io/bitnamicharts/minio
    release_name: datalab-minio
    namespace: datalab
    create_namespace: true
    release_state: present
    chart_version: "{{ minio_datalab_chart_version }}"
    values:
      mode: standalone
      tls:
        enabled: false
        autoGenerated: true
      auth:
        rootUser: admin
        rootPassword: "{{ minio_datalab_root_passwd }}"
      persistence:
        enabled: true
        storageClass: "local-path"
        accessModes:
          - ReadWriteOnce
        size: 256Gi
        mountPath: "/bitnami/minio/data"
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true


#
##
### Criar certificado SSL Cert Manager
##
#

- name: Criar o certificado Minio TLS com cert-manager
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: Certificate
      metadata:
        name: datalab-minio-cert-manager-certificate
        namespace: datalab
      spec:
        secretName: datalab-minio-cert-manager-certificate
        issuerRef:
          name: letsencrypt-prod
          kind: ClusterIssuer
        commonName: "datalab.{{ domain_name }}"
        dnsNames:
          - "datalab.{{ domain_name }}"
          - "*.datalab.{{ domain_name }}"


- name: Criar IngressRoute para o MinIO Web com Traefik 3
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: IngressRoute
      metadata:
        name: ingressroute-minio-web
        namespace: datalab
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-prod"
      spec:
        entryPoints:
          - websecure
        routes:
          - match: "Host(`minio.datalab.{{ domain_name }}`)"
            kind: Rule
            services:
              - name: datalab-minio
                port: 9001
        tls:
          secretName: datalab-minio-cert-manager-certificate
